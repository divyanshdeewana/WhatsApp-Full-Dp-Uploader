<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WhatsApp DP Automation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* (Aapka CSS code yaha same rahega, copy-paste your CSS here) */
        /* Space bachane ke liye maine CSS code hide kiya hai, 
           aap apni purani file se CSS copy karke yaha paste kar lein */
        :root { --primary: #128C7E; --gradient-bg: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); --dark: #1a1a1a; }
        body { font-family: 'Poppins', sans-serif; background: var(--gradient-bg); margin: 0; color: var(--dark); min-height: 100vh; }
        .container { max-width: 600px; margin: 50px auto; padding: 20px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .upload-area { border: 2px dashed #ccc; padding: 40px; margin: 20px 0; border-radius: 10px; cursor: pointer; }
        .form-input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .submit-btn { background: #128C7E; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; width: 100%; }
        .submit-btn:disabled { background: #ccc; }
        .pairing-code { font-size: 32px; font-weight: bold; color: #128C7E; letter-spacing: 5px; margin: 20px 0; background: #e0f2fe; padding: 15px; border-radius: 10px; }
        .hidden { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #128C7E; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h1>WhatsApp DP Updater</h1>
        <p>Upload Image & Enter Number to Set DP</p>

        <form id="uploadForm">
            <!-- Step 1 -->
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('imageInput').click()">
                <i class="fas fa-cloud-upload-alt" style="font-size: 40px; color: #128C7E;"></i>
                <p>Click to Upload Image</p>
                <input type="file" id="imageInput" accept="image/*" hidden required>
            </div>
            <p id="fileName"></p>

            <!-- Step 2 -->
            <input type="tel" id="numberInput" placeholder="919876543210 (Country code, no +)" class="form-input" required>

            <!-- Submit -->
            <button type="submit" class="submit-btn" id="submitBtn">
                <span id="btnText">Get Pairing Code</span>
                <div id="loader" class="loader hidden"></div>
            </button>
        </form>

        <!-- Result -->
        <div id="resultSection" class="hidden">
            <h3>Your Pairing Code:</h3>
            <div class="pairing-code" id="codeDisplay"></div>
            <p>1. Open WhatsApp > Settings > Linked Devices</p>
            <p>2. Tap "Link a device" > "Link with phone number instead"</p>
            <p>3. Enter the code above. DP will update automatically.</p>
        </div>
    </div>

    <script>
        document.getElementById('imageInput').addEventListener('change', function(e) {
            if(e.target.files[0]) {
                document.getElementById('fileName').innerText = e.target.files[0].name;
            }
        });

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('imageInput');
            const phoneInput = document.getElementById('numberInput');
            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('loader');
            const resultSection = document.getElementById('resultSection');
            const submitBtn = document.getElementById('submitBtn');

            if (!fileInput.files[0] || !phoneInput.value) return alert("Please fill all details");

            // UI Loading State
            btnText.classList.add('hidden');
            loader.classList.remove('hidden');
            submitBtn.disabled = true;

            try {
                // 1. Upload Image
                const formData = new FormData();
                formData.append('image', fileInput.files[0]);

                const uploadRes = await fetch('/upload', { method: 'POST', body: formData });
                const uploadData = await uploadRes.json();

                if (!uploadData.filename) throw new Error("Upload Failed");

                // 2. Get Pairing Code
                const connectRes = await fetch(`/connect?phoneNumber=${phoneInput.value}&filename=${uploadData.filename}`);
                const connectData = await connectRes.json();

                if (connectData.error) throw new Error(connectData.error);

                // 3. Show Code
                document.getElementById('codeDisplay').innerText = connectData.code;
                resultSection.classList.remove('hidden');

            } catch (error) {
                alert(error.message);
                console.error(error);
            } finally {
                btnText.classList.remove('hidden');
                loader.classList.add('hidden');
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
                                                                          </html>
